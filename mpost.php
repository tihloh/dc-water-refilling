<?xml version="1.0" encoding="UTF-8" ?> <?php  if ($_SERVER['REQUEST_METHOD'] == 'POST'){  @include "tfx.php";  @include "config.php";  include "conn.php";  include "sms_interpreter.php";   $company="waterstation";  $fullname="";  $pass="";  $rec="";   if (isset($_POST['xml'])) {  $xml = $_POST['xml'];   $myfile = fopen("newfile.xml", "w") or die("Unable to open file!");  fwrite($myfile, $xml);  fclose($myfile);   $collection = simplexml_load_string($xml);   $simno= $collection->sim[0]["number"];  $simfile = fopen("simno.txt", "w") or die("Unable to open file!");  fwrite($simfile, $simno);  fclose($simfile);   foreach($collection->sms as $sms) {  $id=$sms["id"];  $cp=$sms["cp"];  $msg=base64_decode($sms["msg"]);  $msg=str_replace("'", "`", $msg);  $stime=$sms["stime"];  $status=$sms["status"];   if ($status=="0"){  $q="SELECT count(*) cnt FROM tblsms WHERE _out=0 and cp='$cp' and stime='$stime' and hash=md5('$msg')";  $result = $mysqli->query($q);  $row = mysqli_fetch_assoc($result);  $cnt=$row["cnt"];   if ($cnt=='0'){  $newid=uniqid();  $q = "INSERT INTO tblsms(id,cp,msg,stime,hash) VALUES ('$newid', '$cp', '$msg', '$stime', md5('$msg'))";  if($mysqli->query($q)) {  $failed=0; echo "<ok id=\"$id\" cp=\"$cp\" added=\"1\" />";  interpretsms($msg,$stime,$cp);  } else {  $failed=1; echo "<f id=\"$id\" q=\"$q\" />";  }  }else{  echo "<ok id=\"$id\" cp=\"$cp\" added=\"0\" />";  }  }else{  echo "<ok id=\"$id\" cp=\"$cp\" added=\"0\" />";  }  }  ?>  <collection>  <?php  $q="SELECT * FROM tblsms where _out=1 and status=0";  if ($res = $mysqli->query($q)){  $ids="";  while ($row = $res->fetch_assoc()) {  $ids .= ($ids==""?"":",")."'".$row['id']."'";  ?>  <send id="<?php echo $row['id'];?>" cp="<?php echo $row['cp'];?>"  msg="<?php echo base64_encode($row['msg']);?>"  stime="<?php echo base64_encode($row['stime']);?>" /><?php  }  if($ids!=""){  $q="DELETE FROM tblsms where id in ($ids)";  $mysqli->query($q);  }  }  ?> <set acceptall="false" /><?php  ?>  </collection>  <?php  } } ?>

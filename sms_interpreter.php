<?php function getnearestmatchid($tbl, $field, $find){ global $mysqli; $qf=""; $qc=""; $xs=explode(" ",str_ireplace(",","",str_ireplace("'","''",$find))); foreach($xs as &$part){ if(strlen($part)==1){ $part=preg_replace('/[^\p{L}\p{N}\s]/u', '', $part); } if($part!=""){ if ($qf!=""){ $qf .= " or "; $qc .= " + "; } $qf .=" $field like '%".$part."%' "; $qc .=" (LENGTH($field) - LENGTH(REPLACE(UPPER($field), UPPER('".$part."'), '')))/LENGTH('".$part."') "; } } if($qf!=""){$qf=" WHERE $qf "; $qc="(".$qc.") DESC, LENGTH($field), ";} $q="SELECT id FROM $tbl $qf GROUP BY $field ORDER BY $qc $field LIMIT 1;"; $result = $mysqli->query($q); $ret=""; while($row = $result->fetch_assoc()){ $ret=$row["id"]; } return $ret; } function interpretsms($msg,$stime,$cp){ GLOBAL $mysqli; $items = explode(";", $msg); $cust=""; $addr=""; $newid=uniqid(); $items_q=""; $part=""; $charge=0; if(preg_match("/(.+)@(.+);(.+)/i", $msg)==1){ foreach($items as $str){ $str=str_replace(" "," ",trim($str)); if($cust==""){ $parts = explode("@", $str); $cust=$parts[0]; $addr=$parts[1]; }else{ $parts = explode(",", $str); $item=$parts[0]; $qty=$parts[1]; $part .=($items_q==""?"":", ")."$qty $item"; $itemid=getnearestmatchid("tblitems","item",$item); $q="SELECT price FROM tblitems WHERE id='$itemid'"; $result = $mysqli->query($q); $price=0; while($row = $result->fetch_assoc()){ $price=$row["price"]; } $charge +=($price*$qty); if($item!=""){ $items_q .= ($items_q==""?"":", ")."('$newid','$itemid','$qty',0)"; } } } $q="INSERT INTO tblorder_items(orderid, itemid, qty,fromsched) VALUES$items_q"; $result = $mysqli->query($q); $userid=getnearestmatchid("tblusers","fname",$cust); $q="INSERT INTO tblorders(id,userid,time,part,customer,addr,cp,charge) VALUES('$newid','$userid','$stime','$part','$cust','$addr','$cp','$charge'); INSERT INTO tblsms(id,cp,_out,msg,stime) VALUES('$newid','$cp','1','Your orders are $part. Thank you!','$stime');"; $result = $mysqli->multi_query($q); } } ?>
